<!DOCTYPE html>
<html lang="en">
<head>
        <title>My personal blog - misc</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href=".././theme/css/main.css" type="text/css" />
        
        <link href="http://andreacrotti.github.com/personal-blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="My personal blog Atom Feed" />
        
        
        <link href="http://andreacrotti.github.com/personal-blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="My personal blog RSS Feed" />
        

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href=".././css/ie.css"/>
                <script src=".././js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href=".././css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">

<a href="http://github.com/andreacrotti/">

<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />

</a>

        <header id="banner" class="body">
                <h1><a href="../.">My personal blog </a></h1>
                <nav><ul>
                
                
                
                
                
                    <li class="active"><a href=".././category/misc.html">misc</a></li>
                
                </ul></nav>
        </header><!-- /#banner -->
                

            

        
        
            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href=".././configuration-magic.html">Configuration magic</a></h1> 
                    <footer class="post-info">
        <abbr class="published" title="2012-07-24T23:23:47.868024">
                Tue 24 July 2012
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href=".././author/andrea-crotti.html">Andrea Crotti</a>
        </address>
        
<p>In <a href=".././category/misc.html">misc</a>. </p>



</footer><!-- /.post-info --><p>I write a lot of utilities and scripts, that needs to be configurable and as smart as possible.</p>
<p>Finally I found a solution which I think is very powerful and simple to implement, which allows me to have:</p>
<ul class="simple">
<li>a default configuration file in a python module, which contains simply variables.</li>
</ul>
<pre class="code python literal-block">
<span class="n">database</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'user'</span><span class="p">:</span> <span class="s">'user'</span><span class="p">,</span>
    <span class="s">'host'</span><span class="p">:</span> <span class="s">'dbserver'</span><span class="p">,</span>
    <span class="s">'port'</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
<span class="p">}</span>
</pre>
<ul class="simple">
<li>a simple ini file, for example:</li>
</ul>
<pre class="code ini literal-block">
<span class="k">[database]</span>
<span class="na">user</span> <span class="o">=</span> <span class="s">user</span>
<span class="na">host</span> <span class="o">=</span> <span class="s">dbserver</span>
<span class="na">port</span> <span class="o">=</span> <span class="s">1000</span>
</pre>
<p>Which can extend the default configuration or override some values.</p>
<ul class="simple">
<li>a way to pass from the command line extra settings, passing for example</li>
</ul>
<pre class="code bash literal-block">
python myscript.py -D database.user:newuser
</pre>
<p>Will override the settings but is not allowed to create new settings (both to simplify the implementation and to avoid simple typos).</p>
<p>All this is very simple and can be implemented with some Python white magic.</p>
<p>The final parsed configuration is just a dictionary and can is loaded only once, and accessed from every module via <em>get_conf</em>.</p>
<pre class="code python literal-block">
<span class="n">GLOBAL_CONF</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">get_conf</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return the global configuration, loading it first if necessary
    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">GLOBAL_CONF</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">GLOBAL_CONF</span>
        <span class="n">GLOBAL_CONF</span> <span class="o">=</span> <span class="n">load_conf</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">GLOBAL_CONF</span>
</pre>
<p>And the load_conf function is very simple, it takes an optional ini file path and a dictionary with extra settings, and</p>
<ul class="simple">
<li>parses the default python configuration to dictionary</li>
<li>creates a configuration object passing these default values</li>
<li>updates the configuration with the extra settings</li>
</ul>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">load_conf</span><span class="p">(</span><span class="n">conf_file</span><span class="o">=</span><span class="n">DEFAULT_INI_CONF</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">default_conf</span> <span class="o">=</span> <span class="n">module_to_dict</span><span class="p">(</span><span class="n">DEFAULT_CONF_MODULE</span><span class="p">)</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="n">Conf</span><span class="p">(</span><span class="n">conf_file</span><span class="p">,</span> <span class="n">default_conf</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">update_from_vars</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">conf</span>
</pre>
<p>The configuration object does</p>
<ul class="simple">
<li>set the internal dictionary to the default values.</li>
<li>create a ConfigParser object to parse the given ini file.</li>
<li>iterates over the ConfigParser object writing on the internal dictionary with <em>_conf_to_dict</em>. In this implementation a configuration file is allowed to create sections and options which didn't exist, this might be made easily configurable. (For example suppose we want to enable type checking it would make sense to only allow options that are also in the global Python configuration.)</li>
</ul>
<pre class="code python literal-block">
<span class="k">class</span> <span class="nc">Conf</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf_file</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf_dict</span> <span class="o">=</span> <span class="n">default</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">conf_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conf_to_dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_conf_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conf_dict</span><span class="p">[</span><span class="n">sec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">sec</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conf_dict</span><span class="p">[</span><span class="n">sec</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</pre>
<p>These two methods are just added for convenience, so that the configuration can be accessed in the same way as a dictionary and as a namespace:</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf_dict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
</pre>
<p>These two methods instead are used to convert the configuration to and from a list of arguments, very useful to be able to override settings from the command line.</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">to_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict_to_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf_dict</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">update_from_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varargs</span><span class="p">):</span>
    <span class="n">tmp_dic</span> <span class="o">=</span> <span class="n">args_to_dict</span><span class="p">(</span><span class="n">varargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf_dict</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conf_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tmp_dic</span><span class="p">)</span>
</pre>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">args_to_dict</span><span class="p">(</span><span class="n">var_args</span><span class="p">,</span> <span class="n">current_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Take a list of variable settings and construct a dictionary
    [x1.x2:val] -&gt; {'x1': {'x2': val}}
    &quot;&quot;&quot;</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">current_dict</span><span class="p">)</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">tmp</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_args</span><span class="p">:</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">KEY_VAL_SEP</span><span class="p">)</span>
        <span class="n">full</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">full</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">full</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">,</span> <span class="s">&quot;the settings must already contain the variable&quot;</span>
        <span class="n">sub</span><span class="p">[</span><span class="n">full</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">return</span> <span class="n">tmp</span>
</pre>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">dict_to_args</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;Return a list of valid arguments that can be passed, in the form
    [k1.k2:val1, k1.k3:val3, k2.k3:val2]
    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dict_to_args</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span><span class="p">,)):</span>
                <span class="k">yield</span> <span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span><span class="p">,))</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre>
<p>There are <a href=".././configuration-magic.html#disqus_thread">comments</a>.</p>
                </article>
                
                    
<p class="paginator">
    
    Page 1 / 1
    
</p>

                
            </aside><!-- /#featured -->
            
        
        
        
            </ol><!-- /#posts-list -->
            
            </section><!-- /#content -->
        
    


        <section id="extras" class="body">
        
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                        
                            <li><a href="http://docs.notmyidea.org/alexis/pelican/">Pelican</a></li>
                        
                            <li><a href="http://python.org">Python.org</a></li>
                        
                        </ul>
                </div><!-- /.blogroll -->
        
        
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://andreacrotti.github.com/personal-blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                            <li><a href="http://andreacrotti.github.com/personal-blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate">rss feed</a></li>
                            

                        
                            <li><a href="http://twitter.com/andreacrotti/">twitter</a></li>
                        
                            <li><a href="http://github.com/andreacrotti/">github</a></li>
                        
                        </ul>
                </div><!-- /.social -->
        
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://pelican.notmyidea.org/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->




<script type="text/javascript">
    var disqus_shortname = 'andreacrotti';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</body>
</html>